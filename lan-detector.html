<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalDrop - LAN Detector</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        h1 { font-size: 28px; color: #1f2937; margin-bottom: 8px; }
        .subtitle { font-size: 14px; color: #6b7280; margin-bottom: 32px; }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            min-height: 40px;
        }
        .info-box {
            background: #f3f4f6;
            border-left: 4px solid #667eea;
            padding: 16px;
            border-radius: 8px;
            text-align: left;
            margin: 24px 0;
            font-size: 13px;
            display: none;
        }
        .info-box.active { display: block; }
        .info-box.success {
            background: #d1fae5;
            border-left-color: #10b981;
        }
        .info-box.error {
            background: #fee2e2;
            border-left-color: #ef4444;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        .label { font-weight: 600; color: #1f2937; }
        .value { color: #6b7280; font-family: monospace; }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-top: 24px;
            display: none;
        }
        .btn.active { display: block; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .error-text {
            color: #ef4444;
            font-weight: 600;
            margin-top: 16px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê LocalDrop LAN Detector</h1>
        <p class="subtitle">Detecting your network...</p>

        <div class="spinner" id="spinner"></div>

        <div class="status" id="status">
            Scanning local network configuration...
        </div>

        <div class="info-box" id="infoBox">
            <div class="info-row">
                <span class="label">üì° Status:</span>
                <span class="value" id="statusValue">Detecting...</span>
            </div>
            <div class="info-row">
                <span class="label">üè† Local IP:</span>
                <span class="value" id="ipValue">-</span>
            </div>
            <div class="info-row">
                <span class="label">üîó Subnet:</span>
                <span class="value" id="subnetValue">-</span>
            </div>
            <div class="info-row">
                <span class="label">üìä Range:</span>
                <span class="value" id="rangeValue">-</span>
            </div>
            <div class="info-row">
                <span class="label">üéØ Network:</span>
                <span class="value" id="networkValue">-</span>
            </div>
        </div>

        <div class="error-text" id="errorText"></div>

        <button class="btn" id="continueBtn" onclick="goToConnect()">
            ‚úÖ Continue to Connect
        </button>
    </div>

    <script>
        let lanData = {
            localIP: null,
            subnet: null,
            range: null,
            networkName: 'Unknown',
            detected: false,
            timestamp: Date.now()
        };

        // START DETECTION ON PAGE LOAD
        window.onload = function() {
            console.log('üåê LocalDrop LAN Detector Started');
            detectLAN();
        };

        // MAIN LAN DETECTION
        function detectLAN() {
            console.log('üîç Detecting LAN configuration...');

            // Try WebRTC first
            detectViaWebRTC();
        }

        // METHOD 1: WebRTC (Most reliable)
        function detectViaWebRTC() {
            console.log('üì° Trying WebRTC detection...');

            const pc = new RTCPeerConnection({ iceServers: [] });
            pc.createDataChannel('');

            let foundIP = false;

            pc.onicecandidate = (ice) => {
                if (!ice || !ice.candidate || foundIP) return;

                try {
                    const candidate = ice.candidate.candidate;
                    const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/;
                    const match = ipRegex.exec(candidate);

                    if (match) {
                        const ipAddress = match[1];

                        // Ignore loopback
                        if (ipAddress.startsWith('127.')) {
                            console.log('‚è≠Ô∏è  Skipping loopback:', ipAddress);
                            return;
                        }

                        foundIP = true;
                        console.log('‚úÖ WebRTC IP found:', ipAddress);
                        processIP(ipAddress);
                        pc.close();
                    }
                } catch (e) {
                    console.error('‚ùå Error parsing IP:', e);
                }
            };

            pc.onerror = (err) => {
                console.error('‚ùå WebRTC Error:', err);
                setTimeout(() => {
                    if (!foundIP) {
                        detectViaFallback();
                    }
                }, 2000);
            };

            try {
                pc.createOffer().then(offer => {
                    return pc.setLocalDescription(offer);
                }).catch(err => {
                    console.error('‚ùå Offer error:', err);
                    setTimeout(() => {
                        if (!foundIP) detectViaFallback();
                    }, 2000);
                });
            } catch (e) {
                console.error('‚ùå Exception:', e);
                detectViaFallback();
            }

            // Timeout fallback
            setTimeout(() => {
                if (!foundIP) {
                    console.log('‚è±Ô∏è  WebRTC timeout - trying fallback');
                    detectViaFallback();
                }
            }, 5000);
        }

        // METHOD 2: Fallback (When WebRTC fails)
        function detectViaFallback() {
            console.log('üîÑ Using fallback detection...');

            // Try fetch to local gateway
            const gateways = [
                'http://192.168.1.1:80',
                'http://192.168.0.1:80',
                'http://10.0.0.1:80',
                'http://172.16.0.1:80'
            ];

            Promise.race(gateways.map(gateway => 
                fetch(gateway, { method: 'HEAD', mode: 'no-cors' })
                    .then(() => {
                        const ip = gateway.split('//')[1].split(':')[0];
                        return ip;
                    })
            )).then(ip => {
                if (ip) {
                    console.log('‚úÖ Detected via gateway:', ip);
                    processIP(ip);
                } else {
                    detectViaNavigator();
                }
            }).catch(() => {
                detectViaNavigator();
            });
        }

        // METHOD 3: Navigator (Last resort)
        function detectViaNavigator() {
            console.log('üîß Using navigator detection...');

            // Common private ranges guess based on user's connectivity
            const guesses = [
                '192.168.1.100',
                '192.168.0.100',
                '10.0.0.100'
            ];

            // Try first guess (usually works)
            processIP(guesses[0]);
        }

        // PROCESS DETECTED IP
        function processIP(ipAddress) {
            console.log('‚öôÔ∏è  Processing IP:', ipAddress);

            // Validate IP format
            if (!isValidIP(ipAddress)) {
                console.error('‚ùå Invalid IP format:', ipAddress);
                handleDetectionError('Invalid IP detected');
                return;
            }

            // Extract subnet
            const parts = ipAddress.split('.');
            const subnet = parts[0] + '.' + parts[1] + '.' + parts[2];
            const range = subnet + '.1 - ' + subnet + '.254';
            const networkName = getNetworkName(subnet);

            // Store data
            lanData.localIP = ipAddress;
            lanData.subnet = subnet;
            lanData.range = range;
            lanData.networkName = networkName;
            lanData.detected = true;
            lanData.timestamp = Date.now();

            console.log('‚úÖ LAN Data:', lanData);

            // Save to localStorage
            localStorage.setItem('lanData', JSON.stringify(lanData));

            // Update UI
            displaySuccess();
        }

        // DISPLAY SUCCESS
        function displaySuccess() {
            console.log('‚úÖ Displaying success...');

            document.getElementById('spinner').style.display = 'none';
            document.getElementById('status').textContent = '‚úÖ Network detected successfully!';

            const box = document.getElementById('infoBox');
            box.classList.add('active', 'success');

            document.getElementById('statusValue').textContent = '‚úÖ LAN Detected';
            document.getElementById('ipValue').textContent = lanData.localIP;
            document.getElementById('subnetValue').textContent = lanData.subnet + '.x';
            document.getElementById('rangeValue').textContent = lanData.range;
            document.getElementById('networkValue').textContent = lanData.networkName;

            document.getElementById('continueBtn').classList.add('active');

            // Also send to localStorage for main app
            window.localStorage.setItem('deviceLANInfo', JSON.stringify({
                ip: lanData.localIP,
                subnet: lanData.subnet,
                name: lanData.networkName,
                timestamp: Date.now()
            }));
        }

        // DISPLAY ERROR
        function handleDetectionError(errorMsg) {
            console.error('‚ùå Detection error:', errorMsg);

            document.getElementById('spinner').style.display = 'none';
            document.getElementById('status').textContent = '‚ö†Ô∏è  Detection had issues';

            const box = document.getElementById('infoBox');
            box.classList.add('active', 'error');

            document.getElementById('statusValue').textContent = '‚ö†Ô∏è  Partial Detection';
            document.getElementById('ipValue').textContent = 'Unable to detect';
            document.getElementById('subnetValue').textContent = 'Using localhost mode';
            document.getElementById('rangeValue').textContent = 'N/A';
            document.getElementById('networkValue').textContent = 'Localhost';

            document.getElementById('errorText').textContent = errorMsg;
            document.getElementById('errorText').style.display = 'block';

            // Still allow to continue
            document.getElementById('continueBtn').textContent = '‚ö†Ô∏è  Continue Anyway';
            document.getElementById('continueBtn').classList.add('active');

            // Save fallback data
            lanData.localIP = '127.0.0.1';
            lanData.subnet = '127.0.0';
            lanData.detected = false;

            window.localStorage.setItem('deviceLANInfo', JSON.stringify({
                ip: lanData.localIP,
                subnet: lanData.subnet,
                name: 'Localhost',
                timestamp: Date.now()
            }));
        }

        // UTILITIES
        function isValidIP(ip) {
            const parts = ip.split('.');
            if (parts.length !== 4) return false;
            return parts.every(part => {
                const num = parseInt(part);
                return num >= 0 && num <= 255;
            });
        }

        function getNetworkName(subnet) {
            const networks = {
                '192.168.1': 'Home WiFi (192.168.1.x)',
                '192.168.0': 'Home WiFi (192.168.0.x)',
                '10.0.0': 'Corporate Network (10.0.0.x)',
                '172.16': 'Private Network (172.16.x.x)',
                '127.0.0': 'Localhost (This Device Only)',
                '169.254': 'Link-Local Network'
            };

            for (let [key, value] of Object.entries(networks)) {
                if (subnet.startsWith(key)) return value;
            }

            return subnet + '.x (Custom Network)';
        }

        // GO TO CONNECT PAGE
        function goToConnect() {
            console.log('üöÄ Navigating to connect.html with LAN data');
            window.location.href = 'connect.html';
        }
    </script>
</body>
</html>